<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Choc Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #8b5cf6;
            --accent-secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Sarabun', 'Poppins', sans-serif; /* Added Sarabun for better Thai support */
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        /* Utilities */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        a { text-decoration: none; color: inherit; }

        /* Glass Panel */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            transition: transform 0.2s ease;
        }

        /* Topbar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        input[type="date"], input[type="text"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        #compareControls {
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease;
        }
        
        #compareControls.active {
            display: flex;
        }

        /* Stats Grid */
        .section-header h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-primary);
            border-left: 4px solid var(--accent-primary);
            padding-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: transform 0.2s, background 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: var(--glass-highlight);
        }

        .stat-title { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); font-family: 'Poppins', sans-serif; }
        .stat-change { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Charts */
        .chart-wrapper-large { position: relative; height: 350px; width: 100%; }
        .chart-wrapper-small { position: relative; height: 250px; width: 100%; }
        .grid-2-cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-title { font-size: 16px; margin-bottom: 15px; color: var(--text-secondary); }

        /* Tables */
        .scrollable-table {
            overflow-x: auto;
        }

        .top-categories-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
        }

        td { color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .rank-column { width: 60px; text-align: center; }
        .search-input { width: 250px; }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .sort-link { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .sort-link:hover { color: var(--accent-primary); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: #1e1b4b;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
        }

        .modal-close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .modal-close-btn:hover { color: white; }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .loading.active { display: flex; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }

        /* Utility classes for status */
        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-active { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status-inactive { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* AI Summary Styles */
        .ai-summary-content {
            white-space: pre-line;
            line-height: 1.8;
            color: var(--text-primary);
            font-size: 15px;
        }
        .ai-summary-content strong {
            color: var(--accent-secondary);
            font-weight: 700;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 768px) {
            .topbar { flex-direction: column; align-items: flex-start; }
            .controls { width: 100%; }
            .control-row { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Topbar -->
        <div class="topbar glass-panel">
            <h1>üöÄ Online Choc <span style="font-size: 14px; color: var(--text-secondary); font-weight: normal; margin-left: 10px;">Marketing & Sales Dashboard</span></h1>
            <div class="controls">
                <div class="control-row">
                    <label style="color: var(--text-secondary);">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <input type="date" id="startDate" />
                    <span style="color: var(--text-secondary);">-</span>
                    <input type="date" id="endDate" />
                </div>
                <div class="control-row">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="compareToggle"> 
                        <span style="color: var(--text-secondary);">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>
                    </label>
                    <div id="compareControls" class="control-row">
                        <input type="date" id="compareStartDate" />
                        <span style="color: var(--text-secondary);">-</span>
                        <input type="date" id="compareEndDate" />
                    </div>
                </div>
                 <div class="control-row" style="width: 100%; justify-content: flex-end; margin-top: 5px;">
                     <button class="btn" id="refreshBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä / ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì AI</button>
                 </div>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</p>
        </div>

        <!-- AI Summary Section -->
        <div class="glass-panel" id="aiSummaryPanel" style="border: 1px solid var(--accent-primary);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">
                <span style="font-size: 28px;">ü§ñ</span>
                <div style="flex: 1;">
                    <h2 class="chart-title" style="margin: 0; color: var(--accent-primary); font-size: 18px; font-weight: 700;">AI Insight Summary</h2>
                    <span style="font-size: 12px; color: var(--text-secondary);">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span>
                </div>
            </div>
            <div id="aiSummaryContent" class="ai-summary-content">
                <!-- AI Content will be injected here -->
            </div>
        </div>
        
        <!-- Funnel Stats -->
        <div class="section-header"><h2>üéØ Marketing Funnel</h2></div>
        <div class="stats-grid" id="funnelStatsGrid">
            <!-- Populated by JS -->
        </div>

        <!-- Ads Performance -->
        <div class="section-header" style="margin-top: 40px;"><h2>üìä Ads Performance</h2></div>
        <div class="stats-grid" id="adsStatsGrid">
            <!-- Populated by JS -->
        </div>

        <!-- Charts Row -->
        <div class="glass-panel">
            <h2 class="chart-title">üí∞ Daily Ad Spend Trend</h2>
            <div class="chart-wrapper-large">
                <canvas id="dailySpendChart"></canvas>
            </div>
        </div>

        <!-- Campaigns Table -->
        <div class="glass-panel top-categories-table scrollable-table">
            <div class="table-header">
                <h2 class="chart-title" style="margin:0;">üìã Campaign Details</h2>
                <input type="text" id="campaignSearchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç...">
            </div>
            <table>
                <thead id="campaignsTableHeader">
                    <tr>
                        <th><a href="#" class="sort-link" data-sort="name">Campaign Name</a></th>
                        <th>Status</th>
                        <th><a href="#" class="sort-link" data-sort="spend">Spend (THB)</a></th>
                        <th><a href="#" class="sort-link" data-sort="impressions">Impressions</a></th>
                        <th><a href="#" class="sort-link" data-sort="purchases">Purchases</a></th>
                        <th><a href="#" class="sort-link" data-sort="messaging_conversations">Msg Conv.</a></th>
                        <th><a href="#" class="sort-link" data-sort="cpm">CPM</a></th>
                    </tr>
                </thead>
                <tbody id="campaignsTableBody"></tbody>
            </table>
        </div>

        <!-- Sales Performance -->
        <div class="section-header" style="margin-top: 40px;"><h2>üí∞ Sales & Revenue</h2></div>
        <div class="stats-grid" id="salesOverviewStatsGrid"></div>
        
        <h2 class="chart-title" style="margin-left: 5px; margin-top: 20px;">Leads & Conversion</h2>
        <div class="stats-grid" id="salesBillStatsGrid"></div>

        <div class="grid-2-cols glass-panel">
            <div class="chart-container">
                <div class="chart-title">Revenue by Product Type</div>
                <div class="chart-wrapper-small"><canvas id="revenueChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Customer Segmentation</div>
                <div class="chart-wrapper-small"><canvas id="customerChart"></canvas></div>
            </div>
        </div>

        <!-- Channel Performance Table -->
        <div class="glass-panel top-categories-table">
            <h2 class="chart-title">üì° Performance by Channel</h2>
            <table>
                <thead>
                    <tr>
                        <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (Channel)</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• P1</th>
                        <th>P2 Leads</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• UP P2</th>
                        <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</th>
                        <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (THB)</th>
                    </tr>
                </thead>
                <tbody id="channelTableBody"></tbody>
            </table>
        </div>

        <!-- Category Details -->
        <div class="section-header" style="margin-top: 40px;"><h2>üìÇ Category Analytics</h2></div>
        
        <div class="glass-panel">
            <h2 class="chart-title">Revenue Distribution</h2>
            <div class="chart-wrapper-large">
                <canvas id="categoryRevenueChart"></canvas>
            </div>
        </div>

        <div class="glass-panel top-categories-table scrollable-table" style="margin-top: 22px;">
            <div class="table-header">
                <h2 class="chart-title" style="margin:0;">üìã Detailed Category Breakdown</h2>
                <span class="stat-change" style="font-weight: normal; color: var(--text-secondary);">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Transaction Log</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="rank-column">#</th>
                        <th>Category</th>
                        <th>P1 Bills</th>
                        <th>UP P1 Bills</th>
                        <th>UP P2 Bills</th>
                        <th>New Customers</th>
                        <th>Total Revenue</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="categoryDetailTableBody"></tbody>
            </table>
        </div>

        <!-- Upsell Flow -->
        <div class="glass-panel top-categories-table scrollable-table">
            <h2 class="chart-title">üîÅ Upsell Flow (P1 ‚Üí UP P1)</h2>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ P1 (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å) ‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ UP P1 (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏ã‡∏•‡∏•‡πå) ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            </p>
            <table>
                <thead>
                    <tr>
                        <th class="rank-column">Rank</th>
                        <th>From (P1 Product)</th>
                        <th>To (Upsell Product)</th>
                        <th>Conversion Rate</th>
                        <th>Revenue Generated</th>
                    </tr>
                </thead>
                <tbody id="upsellPathsTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div id="modalBody" class="modal-body" style="color: var(--text-secondary);">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            campaigns: [],
            charts: {},
            loading: false
        };

        // --- Helper Functions ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH').format(num);
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const months = [
                "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
                "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."
            ];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
        }

        // Mock Data for Campaigns
        function generateCampaignData() {
            const campaigns = [
                "Advanced Choc Promo", "New Year Gift Set", "Valentine Special", 
                "Dark Choc Lovers", "Milk Choc Bundle", "Retargeting - Cart", 
                "Brand Awareness 2024", "Influencer Collab A", "Flash Sale 9.9"
            ];
            
            return campaigns.map(name => ({
                name,
                status: Math.random() > 0.3 ? 'Active' : 'Paused',
                spend: getRandomInt(5000, 50000),
                impressions: getRandomInt(10000, 500000),
                purchases: getRandomInt(50, 800),
                messaging_conversations: getRandomInt(100, 1500),
                get cpm() { return (this.spend / this.impressions) * 1000; }
            }));
        }

        // --- AI Summary Generation ---
        function generateAISummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Generate Mock AI Data
            const totalSales = getRandomInt(1000000, 5000000);
            const totalBills = getRandomInt(1000, 5000);
            const p1Sales = Math.floor(totalSales * 0.6);
            const upP1Sales = Math.floor(totalSales * 0.25);
            const upP2Sales = totalSales - p1Sales - upP1Sales;
            
            const categories = ['Dark Chocolate', 'Milk Chocolate', 'Gift Boxes', 'Snack Bars', 'Cooking Choc', 'Truffles', 'Hot Cocoa Mix'];
            const top5 = categories.sort(() => 0.5 - Math.random()).slice(0, 5).map(c => ({
                name: c,
                revenue: getRandomInt(50000, 200000),
                bills: getRandomInt(100, 500)
            }));

            const channels = ['Facebook', 'Instagram', 'Line OA', 'TikTok', 'Website'];
            const channelData = channels.map(c => ({
                name: c,
                p1Bills: getRandomInt(50, 200),
                p1Sales: getRandomInt(20000, 80000),
                upP1Bills: getRandomInt(20, 80),
                upP1Sales: getRandomInt(10000, 40000),
                p2Leads: getRandomInt(10, 50),
                upP2Bills: getRandomInt(5, 30),
                totalSales: getRandomInt(50000, 150000)
            }));

            // Construct HTML string based on prompt requirement
            let html = `<strong>--- [‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå] ---</strong>\n`;
            html += `‚Ä¢ ‡∏™‡∏≤‡∏Ç‡∏≤: Bornsong\n`;
            html += `‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${formatDateThai(startDate)} - ${formatDateThai(endDate)}\n\n`;

            html += `<strong>--- [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô] ---</strong>\n`;
            html += `‚Ä¢ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(totalSales)}\n`;
            html += `‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${formatNumber(totalBills)} ‡∏ö‡∏¥‡∏•\n`;
            html += `‚Ä¢ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ P1: ${formatCurrency(p1Sales)}\n`;
            html += `‚Ä¢ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P1: ${formatCurrency(upP1Sales)}\n`;
            html += `‚Ä¢ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P2: ${formatCurrency(upP2Sales)}\n`;
            html += `‚Ä¢ 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:\n`;
            top5.forEach((c, i) => {
                html += `   ${i+1}. ${c.name} (${formatCurrency(c.revenue)})\n`;
            });
            html += `‚Ä¢ 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà P1 ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•:\n`;
             top5.forEach((c, i) => {
                html += `   ${i+1}. ${c.name} - ${formatCurrency(c.revenue)} (${c.bills} ‡∏ö‡∏¥‡∏•)\n`;
            });
            html += `\n`;

            html += `<strong>--- [‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á] ---</strong>\n`;
            channelData.forEach(c => {
                html += `> <strong>${c.name}</strong>\n`;
                html += `   - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• P1: ${c.p1Bills}\n`;
                html += `   - ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ P1: ${formatCurrency(c.p1Sales)}\n`;
                html += `   - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• UP P1: ${c.upP1Bills}\n`;
                html += `   - ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P1: ${formatCurrency(c.upP1Sales)}\n`;
                html += `   - P2 Leads: ${c.p2Leads}\n`;
                html += `   - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• UP P2: ${c.upP2Bills}\n`;
                html += `   - ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(c.totalSales)}\n`;
                html += `\n`;
            });

            const aiPanel = document.getElementById('aiSummaryContent');
            aiPanel.style.opacity = '0';
            setTimeout(() => {
                aiPanel.innerHTML = html;
                aiPanel.style.opacity = '1';
                aiPanel.style.transition = 'opacity 0.5s ease';
            }, 200);
        }

        // --- UI Updaters ---

        function createStatCard(title, value, change, isCurrency = false) {
            const formattedValue = isCurrency ? formatCurrency(value) : formatNumber(value);
            const isUp = change >= 0;
            const arrow = isUp ? '‚ñ≤' : '‚ñº';
            const colorClass = isUp ? 'up' : 'down';
            
            return `
                <div class="stat-card">
                    <div class="stat-title">${title}</div>
                    <div class="stat-value">${formattedValue}</div>
                    <div class="stat-change ${colorClass}">
                        ${arrow} ${Math.abs(change)}% vs last period
                    </div>
                </div>
            `;
        }

        function renderStats() {
            // Funnel Stats
            const funnelHTML = `
                ${createStatCard('Total Spend', getRandomInt(100000, 500000), 12.5, true)}
                ${createStatCard('Impressions', getRandomInt(1000000, 5000000), 5.2)}
                ${createStatCard('Total Clicks', getRandomInt(50000, 200000), -2.1)}
                ${createStatCard('Messaging Conversations', getRandomInt(5000, 20000), 8.4)}
            `;
            document.getElementById('funnelStatsGrid').innerHTML = funnelHTML;

            // Ads Stats
            const adsHTML = `
                ${createStatCard('Cost Per Purchase', getRandomInt(100, 500), -5.5, true)}
                ${createStatCard('ROAS', getRandomInt(2, 8).toFixed(2), 1.2)}
                ${createStatCard('CTR (Link)', getRandomInt(1, 5).toFixed(2) + '%', 0.5)}
                ${createStatCard('CPM', getRandomInt(50, 150), 3.1, true)}
            `;
            document.getElementById('adsStatsGrid').innerHTML = adsHTML;

            // Sales Overview
            const salesHTML = `
                ${createStatCard('Total Revenue', getRandomInt(800000, 2000000), 15.3, true)}
                ${createStatCard('Net Profit', getRandomInt(200000, 600000), 10.1, true)}
                ${createStatCard('Total Orders', getRandomInt(1000, 5000), 9.2)}
                ${createStatCard('Avg Order Value', getRandomInt(500, 1500), 4.5, true)}
            `;
            document.getElementById('salesOverviewStatsGrid').innerHTML = salesHTML;

            // Leads
            const billHTML = `
                ${createStatCard('Total Leads (P1)', getRandomInt(500, 2000), 12)}
                ${createStatCard('Conversion Rate', getRandomInt(20, 50) + '%', 2.3)}
                ${createStatCard('New Customers', getRandomInt(200, 800), 18)}
                ${createStatCard('Returning Customers', getRandomInt(300, 1000), 5)}
            `;
            document.getElementById('salesBillStatsGrid').innerHTML = billHTML;
        }

        function renderCampaignTable() {
            state.campaigns = generateCampaignData();
            const tbody = document.getElementById('campaignsTableBody');
            tbody.innerHTML = '';

            state.campaigns.forEach(camp => {
                const statusClass = camp.status === 'Active' ? 'status-active' : 'status-inactive';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500;">${camp.name}</td>
                    <td><span class="status-badge ${statusClass}">${camp.status}</span></td>
                    <td>${formatNumber(camp.spend)}</td>
                    <td>${formatNumber(camp.impressions)}</td>
                    <td>${formatNumber(camp.purchases)}</td>
                    <td>${formatNumber(camp.messaging_conversations)}</td>
                    <td>${camp.cpm.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderChannelsTable() {
            const channels = ['Facebook', 'Instagram', 'Line OA', 'TikTok', 'Website'];
            const tbody = document.getElementById('channelTableBody');
            tbody.innerHTML = '';

            channels.forEach(ch => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:flex; align-items:center; gap:8px;">
                        <span style="width:8px; height:8px; border-radius:50%; background:var(--accent-primary);"></span>
                        ${ch}
                    </td>
                    <td>${getRandomInt(100, 500)}</td>
                    <td>${getRandomInt(50, 200)}</td>
                    <td>${getRandomInt(20, 100)}</td>
                    <td>${getRandomInt(10, 80)}</td>
                    <td style="font-weight:600; color:var(--success);">${formatCurrency(getRandomInt(50000, 200000))}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCategoryTable() {
            const cats = ['Dark Chocolate', 'Milk Chocolate', 'Gift Boxes', 'Snack Bars', 'Cooking Choc'];
            const tbody = document.getElementById('categoryDetailTableBody');
            tbody.innerHTML = '';

            cats.forEach((cat, index) => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = () => openModal(cat);
                tr.innerHTML = `
                    <td class="rank-column">#${index + 1}</td>
                    <td style="font-weight:500;">${cat}</td>
                    <td>${getRandomInt(100, 300)}</td>
                    <td>${getRandomInt(20, 80)}</td>
                    <td>${getRandomInt(10, 50)}</td>
                    <td>${getRandomInt(5, 40)}</td>
                    <td style="color:var(--accent-secondary); font-weight:600;">${formatCurrency(getRandomInt(20000, 100000))}</td>
                    <td><button class="btn" style="padding:4px 10px; font-size:12px;">View</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderUpsellTable() {
            const tbody = document.getElementById('upsellPathsTableBody');
            tbody.innerHTML = '';
            
            const paths = [
                { from: 'Dark Choc Bar', to: 'Premium Gift Box', rate: '15%', val: 45000 },
                { from: 'Milk Choc Set', to: 'Snack Bar Multi-pack', rate: '22%', val: 32000 },
                { from: 'Cooking Drops', to: 'Silicone Molds', rate: '35%', val: 18000 },
                { from: 'Gift Box S', to: 'Gift Box L Upgrade', rate: '12%', val: 28000 }
            ];

            paths.forEach((p, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank-column">${i + 1}</td>
                    <td>${p.from}</td>
                    <td>${p.to}</td>
                    <td style="color:var(--success); font-weight:600;">${p.rate}</td>
                    <td>${formatCurrency(p.val)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Charts Initialization ---
        function initCharts() {
            // Common Chart Options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8', font: { family: 'Poppins' } } }
                },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                }
            };

            // 1. Daily Spend (Line Chart)
            const ctxSpend = document.getElementById('dailySpendChart').getContext('2d');
            state.charts.spend = new Chart(ctxSpend, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Ad Spend (THB)',
                        data: [12000, 15000, 11000, 18000, 22000, 25000, 19000],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: commonOptions
            });

            // 2. Revenue Pie
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            state.charts.revenue = new Chart(ctxRev, {
                type: 'doughnut',
                data: {
                    labels: ['Chocolate Bars', 'Gift Sets', 'Raw Material', 'Merch'],
                    datasets: [{
                        data: [40, 30, 20, 10],
                        backgroundColor: ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });

            // 3. Customer Pie
            const ctxCust = document.getElementById('customerChart').getContext('2d');
            state.charts.customer = new Chart(ctxCust, {
                type: 'pie',
                data: {
                    labels: ['New', 'Returning', 'VIP'],
                    datasets: [{
                        data: [55, 35, 10],
                        backgroundColor: ['#3b82f6', '#6366f1', '#a855f7'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });

            // 4. Category Bar
            const ctxCat = document.getElementById('categoryRevenueChart').getContext('2d');
            state.charts.category = new Chart(ctxCat, {
                type: 'bar',
                data: {
                    labels: ['Dark Choc', 'Milk Choc', 'Gifts', 'Snacks', 'Baking'],
                    datasets: [{
                        label: 'Revenue',
                        data: [150000, 120000, 90000, 60000, 40000],
                        backgroundColor: '#ec4899',
                        borderRadius: 4
                    }]
                },
                options: commonOptions
            });
        }

        function updateCharts() {
            // Simulate changing data
            state.charts.spend.data.datasets[0].data = Array.from({length: 7}, () => getRandomInt(10000, 30000));
            state.charts.spend.update();

            state.charts.revenue.data.datasets[0].data = [getRandomInt(20,50), getRandomInt(20,50), getRandomInt(10,30), getRandomInt(5,15)];
            state.charts.revenue.update();

            state.charts.category.data.datasets[0].data = Array.from({length: 5}, () => getRandomInt(30000, 150000));
            state.charts.category.update();
        }

        // --- Interaction Logic ---
        function refreshData() {
            const loading = document.getElementById('loading');
            loading.classList.add('active');
            
            // Disable button
            document.getElementById('refreshBtn').disabled = true;

            setTimeout(() => {
                generateAISummary(); // NEW Function Call
                renderStats();
                renderCampaignTable();
                renderChannelsTable();
                renderCategoryTable();
                renderUpsellTable();
                updateCharts();
                
                loading.classList.remove('active');
                document.getElementById('refreshBtn').disabled = false;
            }, 800);
        }

        // --- Modal Logic ---
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.querySelector('.modal-close-btn');

        function openModal(categoryName) {
            modalTitle.innerText = `Details: ${categoryName}`;
            
            // Mock content for the modal
            modalBody.innerHTML = `
                <div style="padding: 10px;">
                    <p style="margin-bottom:15px;">Transaction history for <strong>${categoryName}</strong> over selected period.</p>
                    <table style="width:100%; border-collapse:collapse; color:white; font-size:13px;">
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.1); text-align:left;">
                            <th style="padding:8px;">Order ID</th>
                            <th style="padding:8px;">Customer</th>
                            <th style="padding:8px;">Amount</th>
                            <th style="padding:8px;">Date</th>
                        </tr>
                        ${Array.from({length: 5}).map((_, i) => `
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:8px;">ORD-${getRandomInt(1000,9999)}</td>
                                <td style="padding:8px;">Customer ${getRandomInt(1, 100)}</td>
                                <td style="padding:8px;">${formatCurrency(getRandomInt(500, 2000))}</td>
                                <td style="padding:8px;">2024-01-2${i}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
            
            modal.classList.add('active');
        }

        closeBtn.onclick = () => modal.classList.remove('active');
        window.onclick = (e) => {
            if (e.target === modal) modal.classList.remove('active');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates based on Prompt (2025/2026 era)
            document.getElementById('startDate').value = "2025-09-01";
            document.getElementById('endDate').value = "2026-01-29";

            // Toggle compare
            const compareToggle = document.getElementById('compareToggle');
            const compareControls = document.getElementById('compareControls');
            compareToggle.addEventListener('change', (e) => {
                if(e.target.checked) {
                    compareControls.classList.add('active');
                } else {
                    compareControls.classList.remove('active');
                }
            });

            // Search Filter for Campaigns
            const searchInput = document.getElementById('campaignSearchInput');
            searchInput.addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#campaignsTableBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });

            // Refresh Button
            document.getElementById('refreshBtn').addEventListener('click', refreshData);

            // Initial Load
            initCharts();
            refreshData(); // This will trigger AI generation immediately
        });

    </script>
</body>
</html>
